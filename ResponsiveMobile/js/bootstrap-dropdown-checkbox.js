(function(root,factory){if(typeof exports==='object'){module.exports=factory();}
else if(typeof define==='function'&&define.amd){define(['jquery'],factory);}
else{factory(root.jQuery);}}(this,function($){'use strict';var defer=function defer(fn){if(window.requestAnimationFrame){window.requestAnimationFrame(fn);}
else{setTimeout(fn,0);}};var wrapMaxItems=function wrapMaxItems(content,limit,total){return('<div class="alert maxitems">'+content+'</div>').replace('{limit}',limit).replace('{total}',total);};var template='\
    <!--button class="dropdown-checkbox-toggle" data-toggle="dropdown" href="#">Dropdown trigger </button-->\
    <div class="dropdown-checkbox-content" style="color:#000;position:relative;margin:10px;">\
      <div class="dropdown-checkbox-header">\
        <input class="checkbox-all" type="checkbox">All Options&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" placeholder="Type filter word here" class="search" style="width:65%;"/><button onclick="selectpoint();">[Pick]</button><button onclick="searchpoint();">[Search]</button>\
      </div>\
      <ul class="dropdown-checkbox-menu"></ul>\
    </div>';var templateOption='<li><div class="layout1"><input type="checkbox"/><label></label></div></li>';var templateNoResult='<li><div class="layout"><label>No results.</label></div></li>';var templateNbSelected=' <span class="dropdown-checkbox-nbselected"></span>';var templateMaxResults='Showing {limit} of {total} items<br>Use search to filter your results.';var DropdownCheckbox=function(element,options){$(element).html(template);$(element).addClass('dropdown-checkbox dropdown');this.$element=$(element).find('.dropdown-checkbox-toggle');this.$parent=$(element);this.$list=this.$parent.find('ul');this.data=[];this.hasChanges=false;this.showNbSelected=false;this.maxItems=false;this.alternate=false;if(typeof options==='object'){this.$element.text(options.title);this.$element.addClass(options.btnClass);this.autosearch=options.autosearch;this.data=options.data||[];this._sort=options.sort||this._sort;this.sortOptions=options.sortOptions;this.hideHeader=options.hideHeader||options.hideHeader===undefined?true:false;this.templateButton=options.templateButton;this.showNbSelected=options.showNbSelected||false;this.maxItems=options.maxItems||false;this._query=options.query||this._query;this._queryMethod=options.httpMethod||'GET';this._queryParse=options.queryParse||this._queryParse;this._queryError=options.queryError||function(){};this._queryUrl=options.queryUrl;this.templateMaxResults=options.templateMaxResults||templateMaxResults;this.alternate=!!options.alternate;}
if(this.showNbSelected)this.$element.append(templateNbSelected);if(this.templateButton){this.$element.remove();this.$parent.prepend(this.templateButton);this.$element=this.$parent.find('.dropdown-checkbox-toggle');}
this.$element.attr('data-toggle','dropdown');if(this.hideHeader)this.$parent.find('.dropdown-checkbox-header').remove();this.$parent.find('.dropdown-checkbox-content').on('click.dropdown-checkbox.data-api',function(e){e.stopPropagation();});this.$element.on('click.dropdown-checkbox.data-api',$.proxy(function(){var isOpened=this.$parent.hasClass('open');$('.dropdown').removeClass('open');if(isOpened)this.$parent.addClass('open');this.$parent.toggleClass('open');if(this.hasChanges)this.$parent.trigger('change:dropdown-checkbox');this.hasChanges=false;return false;},this));this.$parent.find('.checkbox-all').on('change.dropdown-checkbox.data-api',$.proxy(function(event){this.onChangeCheckboxAll(event);this._showNbSelected();},this));$(document).on('click.dropdown-checkbox.data-api',$.proxy(function(){this.$parent.removeClass('open');if(this.hasChanges)this.$parent.trigger('change:dropdown-checkbox');this.hasChanges=false;},this));this.$parent.find('.dropdown-checkbox-header').on('keyup.dropdown-checkbox.data-api',$.proxy(DropdownCheckbox.prototype.onKeyup,this));this.$parent.find('ul').delegate('li input[type=checkbox]','change.dropdown-checkbox.data-api',$.proxy(function(event){this.onChangeCheckbox(event);this._showNbSelected();},this));this._reset(this.data);this._showNbSelected();this._refreshCheckboxAll();};DropdownCheckbox.prototype={constructor:DropdownCheckbox,_sort:function(elements){return elements;},_query:function(type,url,success,error){return $.ajax({type:type,url:url+'?q='+this.word,dataType:'json',cache:false,contentType:'application/json',success:$.proxy(success,this),error:error});},_querySuccess:function(data){var results=this._queryParse(data);if(results.length>0)return this._reset(results);return this.$list.html(templateNoResult);},_queryParse:function(data){return data;},_removeElements:function(ids){this._isValidArray(ids);var tmp=[],toAdd=true;for(var i=0;i<this.data.length;i++){for(var j=0;j<ids.length;j++){if(ids[j]===parseInt(this.data[i].id,10))toAdd=false;}
if(toAdd)tmp.push(this.data[i]);toAdd=true;}
this.data=tmp;return this;},_getCheckbox:function(isChecked,isAll){var results=[];for(var i=0;i<this.data.length;i++){if(isChecked===this.data[i].isChecked||isAll){results.push(this.data[i]);}}
return results;},_isValidArray:function(arr){if(!$.isArray(arr))throw'[DropdownCheckbox] Requires array.';},_findMatch:function(word,data){var results=[];for(var i=0;i<data.length;i++){if(data[i].label.toLowerCase().search(word.toLowerCase())!==-1){results.push(data[i]);}}
return results;},_findById:function(id){for(var i=0;i<this.data.length;i++){if(id===this.data[i].id){return this.data[i];}}
return null;},_setCheckbox:function(isChecked,id){var item=this._findById(id);if(item){item.isChecked=isChecked;}},_isDataItemChecked:function(item){return!!item.isChecked;},_anyChecked:function(){return this.data.some(this._isDataItemChecked);},_allChecked:function(){return this.data.every(this._isDataItemChecked);},_noneChecked:function(){return!this._anyChecked();},_checkedLength:function(){return this.data.filter(this._isDataItemChecked).length;},_refreshCheckboxAll:function(){var state=this._anyChecked();if(this.alternate){if(this._allChecked()||this._noneChecked()){state=true;}
else{state=!this._anyChecked();}}
this.$element.parents('.dropdown-checkbox').find('.checkbox-all').prop('checked',state);},_resetSearch:function(){this.$parent.find('.search').val('');this._reset(this.data);return this;},_createListItem:function(item){var id=item.id,label=item.label,isChecked=item.isChecked,uuid=new Date().getTime()*Math.random(),allChecked=this._allChecked();var node=this.listItemPrototype.cloneNode(true);var container=node.firstChild;$(node).data('id',id);container.firstChild.id=uuid;container.firstChild.checked=this.alternate&&allChecked?false:isChecked;container.lastChild.textContent=item.country+" : "+label+" : "+item.lat+","+item.lon;container.lastChild.setAttribute('for',uuid);return node;},_appendOne:function(item){this.$list.append(this._createListItem(item));return this;},_refresh:function(){},_append:function(data){if(!this.listItemPrototype)this.listItemPrototype=$(templateOption)[0];if(!$.isArray(data))data=[data];var len=this.maxItems?Math.min(this.maxItems,data.length):data.length;var remainder=data.length-this.maxItems;var maxItems=this.maxItems;var batchsize=100;var templateMaxResults=this.templateMaxResults;var createListItem=this._createListItem.bind(this);var $list=this.$list;var i;var $container=this.$parent.find('.dropdown-checkbox-content');data=this._sort(data,this.sortOptions);(function appendBatch(index){var fragment=document.createDocumentFragment();for(i=index;i<Math.min(index+batchsize,len);i++){fragment.appendChild(createListItem(data[i]));}
$list[0].appendChild(fragment);if(i<len){defer(appendBatch.bind(null,i));}
else{if(remainder>0&&maxItems){$container.append(wrapMaxItems(templateMaxResults,maxItems,data.length));}}})(0);this._showNbSelected();return this;},_reset:function(items){if(this.alternate&&this._noneChecked()){this.data.forEach(function(item){item.isChecked=true;});}
this._isValidArray(items);this.$parent.find('.maxitems').remove();this.$list.empty();this._append(this._sort(items));this._refreshCheckboxAll();return this;},_showNbSelected:function(){if(!this.showNbSelected)return;var moreinfo='('+this._checkedLength()+')';moreinfo+="<div style='width: 110%;max-height: 70px;margin-left:0%;overflow: scroll;overflow-x:hidden;text-align: center;'>";var elements=this.data.filter(this._isDataItemChecked);for(var i=0;i<elements.length;i++)
moreinfo+="<br>"+elements[i].country+"["+elements[i].label+"]";moreinfo+="</div>";this.$element.find('.dropdown-checkbox-nbselected').html(moreinfo);return this;},onKeyup:function(event){var keyCode=event.keyCode,word=this.word=$(event.target).val();if(word.length<1&&keyCode===8){this.$parent.find('.checkbox-all').show();return this._reset(this.data);}
if(keyCode===27){this.$parent.find('.checkbox-all').show();return this._resetSearch();}
if(this.alternate){this.$parent.find('.checkbox-all').hide();}
if(this.autosearch||keyCode===13){if(this._queryUrl){this._query(this._queryMethod,this._queryUrl,this._querySuccess,this._queryError);}else{var results=this._findMatch(word,this.data);if(results.length>0)return this._reset(results);return this.$list.html(templateNoResult);}}},onChangeCheckboxAll:function(event){var isChecked=$(event.target).is(':checked');var alternate=this.alternate;var $elements=this.$parent.find('ul li');var self=this;var checkboxState=isChecked;var modelState=isChecked;if(alternate){if(isChecked){checkboxState=false;modelState=true;}
else{checkboxState=false;modelState=false;}}
$elements.each(function(){$(this).find('input[type=checkbox]').prop('checked',checkboxState);self._setCheckbox(modelState,$(this).data('id'));});if(alternate&&isChecked){this.data.forEach(function(item){item.isChecked=true;});}
this.$parent.trigger('checked:all',isChecked);isChecked?this.$parent.trigger('check:all'):this.$parent.trigger('uncheck:all');if(alternate&&modelState===false){this.data.forEach(function(item){item.isChecked=false;});$elements.first().each(function(){$(this).find('input[type=checkbox]').prop('checked',true);self._setCheckbox(true,$(this).data('id'));});}
this.hasChanges=true;updatescene();},onChangeCheckbox:function(event){var checked=$(event.target).prop('checked');var id=$(event.target).parent().parent().data('id');if(this.alternate&&this._allChecked()&&checked){this.data.forEach(function(item){item.isChecked=false;});this._setCheckbox(true,id);}
else if(this.alternate&&this._checkedLength()===1&&!checked){this.data.forEach(function(item){item.isChecked=true;});this._setCheckbox(true,id);}
else{this._setCheckbox(checked,id);}
this._refreshCheckboxAll();this.$parent.trigger('checked',checked);checked?this.$parent.trigger('check:checkbox'):this.$parent.trigger('uncheck:checkbox');this.hasChanges=true;updatescene();},checked:function(){return this._getCheckbox(true);},unchecked:function(){return this._getCheckbox(false);},items:function(){return this._getCheckbox(undefined,true);},append:function(elements){if(!$.isArray(elements)){this.data.push(elements);}else{for(var i=0;i<elements.length;i++)
this.data.push(elements[i]);}
elements=this._sort(elements);this._append(elements);this.hasChanges=true;},remove:function(ids){if(!$.isArray(ids))ids=[ids];this._isValidArray(ids);this._removeElements(ids);this._reset(this.data);this.hasChanges=true;},reset:function(elements){if(!$.isArray(elements)){this.data=[elements];}else{this.data=elements;}
this._reset(elements);this.hasChanges=true;}};$.fn.dropdownCheckbox=function(option,more){var $this=$(this),data=$this.data('dropdownCheckbox'),options=typeof option=='object'&&option;if(!data)$this.data('dropdownCheckbox',(data=new DropdownCheckbox(this,options)));if(typeof option=='string')return data[option](more);return this;};$.fn.dropdownCheckbox.Constructor=DropdownCheckbox;}));